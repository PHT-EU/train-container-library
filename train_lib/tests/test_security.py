import pytest
import os
from io import BytesIO
import json
from cryptography.fernet import InvalidToken

from train_lib.security.Hashing import hash_immutable_files, hash_results
from train_lib.security.SymmetricEncryption import FileEncryptor, Fernet


@pytest.fixture
def config_dict_as_json():
    config_dict = {
        "user_id": 1,
        "train_id": "encrypted",
        "session_id": "da5b1de1025815cf4f2f7adfd6009ef5e516db6b15c2e895833b761ade7a3c1be0dd2e46aac70fb88f557963f628d9c2ece3e6597dcd50788cc9fde3d10b8a3b",
        "rsa_user_public_key": "2d2d2d2d2d424547494e205055424c4943204b45592d2d2d2d2d0a4d494942496a414e42676b71686b6947397730424151454641414f43415138414d49494243674b4341514541304d742f447737795059486e33527848722f48360a376e4b66636b466d4262447a316e2f7a6b735970696d656f727a326a49484f30317344613333526369734c4431483955645172524a76517878613654744d586b0a636f63324d514c344150614e3939582b39797562464150677854397853484e676d306a4c54746a4c524e6878515573654b75454f524e38366e696e354446504f0a44516371517171324b71434a7349526b656145636f37673838652b3945434f6e48412f37457577767956344a777730346d772f667449442f66446f43555330710a41506a6d2b544e5a4373764a706c376949556678424d546e47566656372f4c4b48554478637975446a64357966524d6c433776414837476a6e55527170464f4e0a4e654653444162696358386576313332366d38383057646e72364f6b796d532b4f6c4d562f4334636a6a47374435755a4d6539516f4b4d64325472324b6d64390a50514944415141420a2d2d2d2d2d454e44205055424c4943204b45592d2d2d2d2d0a",
        "encrypted_key": {
            "aachen": "29bbde3609b3ad1f4a8654b5a95e97acf8fe2d504bfb72258e854f83ca4e257a26ca3a11b9a37d28ce8991b91cd45e48fc8fb2183bcddc1529c2ba9ce267f13be3416f195423a92b210c64dc80b460c025fcd5cd68aa9cb1d62ca65db3ec2f09ea9430d01c9f90ad4b7b015e1373adea2e629813f40d09aae8ddeda3f74290424e2b2dfd71ca9d2453eb41d8160a775d8bc359ec9a6e3a6d76eba9aef4cbf680011980dbe39642878138e51c7cb2a3b2112624723876c614705ca0c6f5d281ff6ae2a71bae29b05ad3d86b69dde9fd2d9c46678402c280f662c2a089c140b74ec1b95aca929008f0520346127d7b80183d051b2d50f870569b7ec98017fe4172",
            "tuebingen": "a39a0ed82566967cb9e2a6ca47793f821231d5c9f7e210fe16d3d73a2506ebecaf807c1d6bb10d6458eecea491d253499f2578ff97e06108e316ec0c1aa26beb6ee7c63c5f47456ff561b9b3160a1f68dae0bf081168fb9165e96f4f9b8e27adfd4242245fec8191e2c7742a6836ced9b8c8d4521951c87eeb20d71a9bb32dd9fd65c43c667b884a1406205238949534ae49245e80817d70a76d6eb0e56ad2d91e072d4f9e7a4890b4649a122f913202e48ffc499333e46eefab27c2d517957b8c2e28ca44294d8b6d7e568db9f912de2984c9ad3bcadabf6fc6cba4ee077c4457bb136a42f612142cbdd5cb8758b60f1b84b016418a63f244d6f76b27d1dbc7",
            "leipzig": "9de0b3ef7be8ffd46d0334b252d2ccce00e21ed5c617599a470647054e52f4ef8b715a4772d4833d6bde62ea6f304f5c20bf0db3ef73f1a7304e31de73673c5c0f72b16182f284f26d53f8d76e2d8570ef48f261874395cab363a84e79705cce16e9a4fdcb02b10c7f3dca29da320bf02f32647e5a9930f1e53a481f3eeebe2a1e2b8368d926fd08c1f098dc30c28996de34047688a810f72abc5418c1e8b026cfdd96f90963c10d57746f32e374eb73b15fc82304c5b1e080b0cda590245a815207206dc3e469168f9c355a8cc1db761236992dabb0526fd6330b41b3ba6c8218ee37242f6457fd277c950f4f22cd505a24f9915739e3955aac16edf24d4441"
        },
        "rsa_public_keys": {
            "aachen": "2d2d2d2d2d424547494e205055424c4943204b45592d2d2d2d2d0a4d494942496a414e42676b71686b6947397730424151454641414f43415138414d49494243674b4341514541774763643564554d715673475a6d526935645a480a6d4a564f392b68426672313962704155417973354f74384c766a337a464e625370377372434c6e766c68633577524c7a4e6b4270346444552f7846592b5238460a6e4e673672506d58466e3678462b4e6643773372656e6e484e697534642b4e6a354e4a34664176556d5252796c4c51526b7077446a5375424479376e35306c770a61716a596652553571524e42465935614437662f696f596e644336642b6359545077385a686f34395032477169687a653671517356566c735335562f3637306e0a4775674b776d32423850775539566f48505168615a72446165437a772b6438314e3053336b64696d4d70524d585863795a45635648774a54695a3942597073760a7965723930323979784459474d4f6e384c693434772f4253584b39552b39396b34506f64364e5536454751537039317556514c5a31467047675a6b70387534740a66514944415141420a2d2d2d2d2d454e44205055424c4943204b45592d2d2d2d2d0a",
            "tuebingen": "2d2d2d2d2d424547494e205055424c4943204b45592d2d2d2d2d0a4d494942496a414e42676b71686b6947397730424151454641414f43415138414d49494243674b4341514541352b364c4639355236575838554970513341582b0a744b513342685162764d48615647716b63656a494b6a6f493536444967682b79582f4a7862327053693742594866434e7a6a4c5672616551792f32782b354a520a4d763976462b7a4d6f37334a464d675a5661576d6e45697132682b376e4436682b6f415445664f46716e4e36637767505747616f53684b4643494676444c64550a306962344952435a6d326d664a765177525352356668505475523367612f7a682b7a43485066524c764d624b6b57795a33316f665446506e436d356e465050730a3269544176463432642b4d51704866566e6671627a686978516c4b59757244666662456152315067586949747544734e6f666e6861386f4c4a656d7a7a6b6c450a76706b6737643132452f334838504775426c432f694c2b4e4d5a4c6673556c6c65464a5a7a584331582b4376445a53517a693379577a786e4d4b317a48746c460a57514944415141420a2d2d2d2d2d454e44205055424c4943204b45592d2d2d2d2d0a",
            "leipzig": "2d2d2d2d2d424547494e205055424c4943204b45592d2d2d2d2d0a4d494942496a414e42676b71686b6947397730424151454641414f43415138414d49494243674b434151454133594673526677472f2b444d5a6e5843426f56660a6e4f4543514952576d512b584439733063514351586b2b4d4466713650396a796756554e6457724a4b4553564b574c707663417265775062424d72365475394f0a79722f65372f646d6c696f79647132436a784a78414e6c575366654d6d38315865466d58364949714f564265645446423765665a7170415a51624564504365470a754c7734424979554949764364316d7361735a6b6d5a634c7169454f724d4d6e656a35562f56726343343137714257544f2f526e39305275456963782f5873500a383239354156746b52496445616f3157384b47464c432b564b4e623775464f3558314759526b58644a6352734742646c76737273364d563169322f72686753450a713478563535566b39663138586d546f3952645148752b4c456e3771673031732b7a2f394c6478484233515a4a6533616335624d7a613458765671437579376c0a6d774944415141420a2d2d2d2d2d454e44205055424c4943204b45592d2d2d2d2d0a"
        },
        "e_h": "de0053cd0e55607bec5c99a5a5a10897b2c50f25d5a7c5f9191e91829d2e16e3ef2256d9f275cad5a88bc819812c8aabb4b4129c7d26ce8cac2f3f9b21438854",
        "e_h_sig": "75a1bc3edb6f6e1e347e11a31947690f84433fc6d8be802ae099f527241b6f9d576900c60ecd12b7c3be21a7d91de60f15c9caa0efafd1bd423d0ee9b165558aed89c23ddb16675a207b770684c7d85875d05810204cce23d027060e7d82b2b5180c3e4d42d69269f1553d69d716c4099e2a74b0d914d6c129abfe92b942dd2dd1a91bcc84297bd080f18f30e4a0244efc6fcf52a5d39cdeb3c090505e71832cd3c705c97f9ac14b91f7272d7f822160dc0291c172165b37c9e0149c272205f3ac5548a8e38fa1dda3202bd1f2be6fa4fca4c2e7561ed2ef71ebc109c544487c47e0be656fe59c5e1c226dd0bc4a9cd6a967c3b01a748f987bf59f29ca7874de",
        "e_d": "07e3c6c3a1d44bb6220b3d0dd3fa5f64206f88f9426e9f74426deaf59ab3e9158d4a2ff86a69fdcf2ab8912a4b149580c55bfa72c91e6c61db73da7d9290fc20",
        "digital_signature": [
            {
                "station": "tuebingen",
                "sig": [
                    "d12f123fea618193a39b9e9f80030b23f685e9aba32a6cebda3106e3481c01d3e19cb0634d7d22af22cfa26554fe28f47c9009fe71d9a5873c66932c7df63ff5452a48302b9a21ffdf76008261925f1837a2610844f7a3aa0dcd00720b1b3935b2ed6a4ee1c4987b7708c305748889209391f46cc2257a22e0935924ddeb773931d61bfedcc3b24e8ab6337fe585ae990faf12688e973c4bf43b095c8cae1808f5fc74c4ee1f6b0f6647349c271c2b9a57281f080cb496e89b117c5ef4fbd1268510501a91ced57d21b8c4197081e3bd7c8b9ebfeae435dfd00835ed9b719cbfc9fb10356a11d524b343f0b66d263dbc4f57c37edc07f6f73a493b0435cff02b",
                    "615355fa46b08b4edbecfee8bfb893f03dae1f096d46802029f5a3ba1db6955807331c0483f8df54d77b6738958ea8da0cf78aec8b1a8e9592dc0fa126da4df9"
                ]
            },
            {
                "station": "tuebingen",
                "sig": [
                    "ce1b9db7699b00b54da947c2580baf280926d92c92328f3426a146f29ec47a915517be5c9a32044b738d3e68058f0dca6a26d77462e2466f4573c41fa133a16422a69ddcf8758b0c60798a39bf33d9846288ba40242bea527021e7b4c1261f3706e351f6ac27fe51ca1c459ba679bd9e93c6623c341294b678c5685ebe11e8835849481e3715bab3c3666aee2d59518ebc997b469005bd7331bf1dfd97b0ef8bc285ccd0b6202da450ed1d902bd3df44d4cb85d244d5eee6020e5f7ece79be2c6add06d5762bceb38c64bbf7b3c1c70e34a8db0758499a063777b9ab1970ada6b85609437d65b25a05d36b4c63cbec2b772f163760541754839621d2d6c2c29b",
                    "30df4ffea39759edbdbc1c7fd9e55f3d9cbdd5184a10c98bc9af3f9f33f49029c02a4eea6361f9595be8323eaca54e709b431298312c22f4e36df6016f53dd89"
                ]
            },
            {
                "station": "tuebingen",
                "sig": [
                    "315674daec53cb4b2a37ad70500bbd820e48a377175f1d9bb468de09b1819061531c911cd879572e933586479e99a9203bf6c60d3ef8594db0b4c8a23f24b6c320290ef6d3be9581f9e007335fe74097e2517aaabcb44cc30fe7ca4e9db26592696ca25132d58cad6cd04ba3867fcfecdfdab150cba7f36c37dbbe4636bdacde8b1aadbf8800f2115919a7135ffde9fa80e539e30552a42116c847e04706d3e9d6f9c6898cfb28d10392034c21d3ee48c7509291dabe879b3e3e2e47dd4740bab3594bc5306107750d5fc08c85b4e8ad9c1ec5e19c7c7228bd617623a1695c879c2aacb2da91992008ce601a164457a89d353427763ad281310d93362e3cfbce",
                    "66f6605fcd76b905a02c8257f247af8bf8255187f517f808a3e442f6b7e977af589cc227a1b43c7a706e4fdd4e6da84f9fac957f15d7d2fe2b00ce54fd368f51"
                ]
            }
        ],
        "e_d_sig": "c77a7874f83e34a3b0695d468dda0f8a56599604976a8111e73c13f37dd4931b8aff0adaebb47eea2c2a17aa45c8a2822a9c423e5fcac0871d6d52e97f9367db5797b0820622d919c1c13a972363fd1572aa6ffafe5515c1c73037bb51675dc3ecdf939f235da5f9c60317b1c68e2e9ed63abf7966ddb3bddc8a1aa2fdde7ed966364d9e7b36e806d6b6b264657c61643725114038c8ad1113702a3217db5da34a5fecbfe1c009a3aa5616753e2ce744d5a82ff1e075e67e28faf25326af3ec9aa23ed928cbc1861367fabdf2e97ce32c4d146798981224da9874829f264a15fe81bb28a200184477c7b385986527ab0045c0ea8a8279fa51948cfb0e0108cbb",
        "user_encrypted_sym_key": "9526c2f8fd58b76f54246b911a4b07c0dcf645223f417440b1dbbd89615c7a9db248c9bb331208807ae7055d8126691f79bc2bfd7dc754dfab772e17a86d3ce23aaf00b3a050991a8381203b21eb64fe0f80dc11406791d35e5dd28dfdaa4158199a865dd9cb441950e5bf78ddf1aba627bf0d9b2a976b7197a819ccd93f004d0ce83340c3b9388d3bb02b8f67f933c5dc6af526ebe7a8ef1191b1ae1819eb664c7f3848b31149092bf634ba18601660380710fe53761135ce0e44431af73e21c57f97dd3e67bbd152e7fd6c559eb464ecd43df968649b845a811c2d7d40f387852856525220a96eaf95947c746c688f1ff30ef3893d3e0064b7673d2ed79192"
    }
    return json.dumps(config_dict)


def test_encryption_decryption(config_dict_as_json):
    file_encryptor = FileEncryptor(Fernet.generate_key())

    files = [BytesIO(config_dict_as_json.encode("utf-8"))]
    # Test in memory encryption
    encrypted_files = file_encryptor.encrypt_files(files, binary_files=True)
    assert encrypted_files

    decrypted_files = file_encryptor.decrypt_files(encrypted_files, binary_files=True)

    file_content_changed = False
    for i, file in enumerate(files):
        file.seek(0)
        file_content = file.read()
        decryted_content = decrypted_files[i].read()
        if not file_content == decryted_content:
            file_content_changed = True

    assert not file_content_changed

    # TODO test file encryption with temp files


def test_decryption_fails_with_wrong_key():
    file_encryptor_1 = FileEncryptor(Fernet.generate_key())
    file_encryptor_2 = FileEncryptor(Fernet.generate_key())

    files = [BytesIO(b"test data")]

    encrypted_files = file_encryptor_1.encrypt_files(files, binary_files=True)
    # Should throw error when decrypting with wrong token
    with pytest.raises(InvalidToken):
        decrypted_files = file_encryptor_2.decrypt_files(encrypted_files, binary_files=True)


def test_hashing():
    files1 = [BytesIO(os.urandom(7328)), BytesIO(os.urandom(3321)), BytesIO(os.urandom(4251))]
    files2 = [BytesIO(os.urandom(328)), BytesIO(os.urandom(3321)), BytesIO(os.urandom(4251))]

    session_id = os.urandom(64)
    user_id = "test"

    hash = hash_immutable_files(files1, user_id=user_id, session_id=session_id, binary_files=True)
    hash_files_changed = hash_immutable_files(files2, user_id=user_id, session_id=session_id, binary_files=True)

    assert hash != hash_files_changed










